---
- SET ANSIBLE_PORT TO ENV.CFG CONFIGURED PORT
  set_fact:
    ansible_port: "{{ SSHD_PORT }}"

- name: "CHECK ANSIBLE CONFIGURED PORT {{ ansible_port }}"
  wait_for:
    port: "{{ ansible_port }}"
    state: "started"
    host: "{{ inventory_hostname }}"
    connect_timeout: "5"
    timeout: "5"
  delegate_to: "localhost"
  ignore_errors: "yes"
  register: ssh_port

- name: "CHECK IF SSH ANSWERS ON 22"
  wait_for:
    port: "22"
    state: "started"
    host: "{{ inventory_hostname }}"
    connect_timeout: "5"
    timeout: "5"
  delegate_to: "localhost"
  ignore_errors: "yes"
  register: ssh_port_default
  when:
    - ssh_port is defined
    - ssh_port.state is undefined

- name: SET SSH PORT TO 22
  set_fact:
    ansible_port: "22"
  when: ssh_port_default.state is defined
